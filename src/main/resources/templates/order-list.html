<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <title>Danh s√°ch ƒë∆°n h√†ng</title>
    <link rel="stylesheet" th:href="@{/css/order-list.css}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<div sec:authorize="hasAuthority('MANAGER')"
     th:replace="~{taskbar/manager-taskbar :: managerTaskbar}"></div>
<div sec:authorize="hasAuthority('STAFF')"
     th:replace="~{taskbar/staff-taskbar :: staffTaskbar}"></div>
<!-- Main Content -->
<main class="main-content">


<!-- Container -->
<div class="container">
    <h1>Danh s√°ch ƒë∆°n h√†ng</h1>
    <div class="form-row-spacebetween">

        <!-- Filter (left) -->
        <form th:action="@{${base} + '/orders'}" method="get" class="filter-form">
            <label for="status">L·ªçc theo tr·∫°ng th√°i:</label>
            <select id="status" name="status" onchange="this.form.submit()">
                <option value="ALL"      th:selected="${selectedStatus == 'ALL'}">T·∫•t c·∫£</option>
                <option value="PENDING"  th:selected="${selectedStatus == 'PENDING'}">PENDING</option>
                <option value="APPROVED" th:selected="${selectedStatus == 'APPROVED'}">APPROVED</option>
                <option value="REJECTED" th:selected="${selectedStatus == 'REJECTED'}">REJECTED</option>
                <option value="PAID"     th:selected="${selectedStatus == 'PAID'}">PAID</option>
            </select>

            <!-- NEW: sort selector -->
            <label for="sort" style="margin-left:12px;">S·∫Øp x·∫øp:</label>
            <select id="sort" name="sort" onchange="this.form.submit()">
                <option value="newest" th:selected="${selectedSort == 'newest'}">M·ªõi ‚Üí C≈©</option>
                <option value="oldest" th:selected="${selectedSort == 'oldest'}">C≈© ‚Üí M·ªõi</option>
            </select>
        </form>

        <!-- Search (right) -->
        <form th:action="@{${base} + '/orders'}" method="get" class="search-form">
            <label for="orderId">T√¨m ki·∫øm theo ID:</label>
            <input type="number" id="orderId" name="orderId" placeholder="Nh·∫≠p m√£ ƒë∆°n..." required>

            <!-- keep current filters when searching -->
            <input type="hidden" name="status" th:value="${selectedStatus}">
            <input type="hidden" name="sort"   th:value="${selectedSort}">

            <button type="submit" class="btn btn-dark">T√¨m</button>

            <!-- NEW: clear the search but keep current status/sort -->
            <button type="button" class="btn btn-light" onclick="clearOrderSearch()">X√≥a</button>

            <!-- NEW: reset everything to default (ALL + newest) -->
            <a class="btn btn-ghost"
               th:href="@{${base} + '/orders'(status='ALL', sort='newest')}">
                M·∫∑c ƒë·ªãnh
            </a>
        </form>



    </div>

    <!-- B·∫£ng danh s√°ch ƒë∆°n h√†ng -->
    <table>
        <thead>
        <tr>
            <th>M√£ ƒë∆°n h√†ng</th>
            <th>Ng√†y ƒë·∫∑t</th>
            <th>T·ªïng ti·ªÅn</th>
            <th>Tr·∫°ng th√°i</th>
            <th>H√†nh ƒë·ªông</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="order : ${orders}">
            <td th:text="${order.getId()}"></td>
            <td th:text="${order.getOrderDate()}"></td>
            <td th:text="${order.getTotalAmount()}"></td>
            <td>
                    <span th:text="${order.getStatus()}"
                          th:class="'status-badge ' + ${order.getStatus()?.toLowerCase()}"></span>
            </td>
            <td>
                <a class="btn-view" th:href="@{${base} + '/orders/' + ${order.id}}">
                    <span>üëÅ</span> Xem chi ti·∫øt
                </a>
            </td>
        </tr>
        </tbody>
    </table>
    <div id="simplePager" style="margin-top:16px; display:flex; gap:10px; align-items:center;">
        <button type="button" id="prevPage" class="page-btn">‚Äπ</button>
        <span id="pageInfo">1 / 1</span>
        <button type="button" id="nextPage" class="page-btn">‚Ä∫</button>
    </div>
</div>
</main>
<script>
    (function initClientPager(){
        const PAGE_SIZE = 10; // ‚Üê change page size here
        const table = document.querySelector('table');
        if (!table) return;

        const tbody = table.querySelector('tbody');
        const rows  = Array.from(tbody.querySelectorAll('tr'));
        const prev  = document.getElementById('prevPage');
        const next  = document.getElementById('nextPage');
        const info  = document.getElementById('pageInfo');

        if (rows.length === 0) {
            // nothing to paginate (maybe searching by ID returned 0 or 1 row)
            if (prev) prev.disabled = true;
            if (next) next.disabled = true;
            if (info) info.textContent = '0 / 0';
            return;
        }

        let current = 1;
        const total = Math.max(1, Math.ceil(rows.length / PAGE_SIZE));

        function render() {
            rows.forEach((tr, idx) => {
                const page = Math.floor(idx / PAGE_SIZE) + 1;
                tr.style.display = (page === current) ? '' : 'none';
            });
            if (info) info.textContent = `${current} / ${total}`;
            if (prev) prev.disabled = (current <= 1);
            if (next) next.disabled = (current >= total);
        }

        if (prev) prev.addEventListener('click', () => { if (current > 1) { current--; render(); }});
        if (next) next.addEventListener('click', () => { if (current < total) { current++; render(); }});

        render();
    })();
    function clearOrderSearch() {
        const url = new URL(window.location.href);
        url.searchParams.delete('orderId');        // remove the search
        // keep status/sort if present; otherwise set defaults
        if (!url.searchParams.has('status')) url.searchParams.set('status', 'ALL');
        if (!url.searchParams.has('sort'))   url.searchParams.set('sort', 'newest');
        // navigate
        window.location.href = url.pathname + '?' + url.searchParams.toString();
    }
</script>
</body>
</html>
