<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách nhân viên</title>
    <link rel="stylesheet" th:href="@{/css/staff-list.css}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body>
<div th:replace="taskbar/manager-taskbar :: managerTaskbar"></div>
<!-- Main Content -->
<main class="main-content">

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <h1>Quản lý nhân viên</h1>
        </div>

        <div class="header-right">

        </div>
    </header>
    <!-- Page Content -->
    <div class="page-content">
        <!-- Page Header -->
        <div class="page-header">
            <h2 class="page-title">Danh sách nhân viên</h2>
            <div class="page-actions">
                <a th:href="@{'/admin/manager-dashboard'}" class="btn-secondary btn-back">
                    <i class="fas fa-arrow-left"></i> Back to Home </a>
            </div>
        </div>
        <!-- Filter Section -->
        <div class="filter-section" style="margin: 16px 0;">
            <div class="filter-group" style="display:flex; gap: 10px; align-items:center;">

                <input type="text" id="searchInput" placeholder="Tìm kiếm..." class="filter-select"
                       style="max-width: 360px; padding: 8px 10px; border: 1px solid #e9ecef; border-radius: 6px;">
            </div>
            <div class="filter-group">
                <label>Sắp xếp theo tên:</label>
                <div class="sort-container" style="display:flex; gap:8px; align-items:center;">
                    <button type="button" id="sortAscBtn" class="btn-sort">A-Z</button>
                    <button type="button" id="sortDescBtn" class="btn-sort">Z-A</button>
                    <button type="button" id="sortResetBtn" class="btn-sort active">Mặc định</button>
                </div>
            </div>
        </div>
    <!-- Staff Table -->
    <div class="card">
        <div class="card-header">
            <div class="staff-count">
                Số nhân viên (<span th:text="${totalStaff}"></span>)
            </div>
            <div class="card-actions">
                <button onclick="exportStaffExcel()" class="export-excel-btn">
                    <i class="fas fa-download"></i> Xuất Excel
                </button>
            </div>
        </div>

        <div class="table-container">
            <table class="data-table" id="staffTable">
                <thead>
                <tr>
                    <th>Tên nhân viên</th>
                    <th>Email</th>
                    <th>SĐT</th>
                    <th>CCCD</th>
                    <th>Role</th>
                    <th>Hành động</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="staff : ${staffs}">
                    <td>
                        <span class="staff-name" th:text="${staff.fullname}"></span>
                    </td>
                    <td>
                        <span class="staff-email" th:text="${staff.email}"></span>
                    </td>
                    <td>
                        <span class="staff-phone" th:text="${staff.phone}"></span>
                    </td>
                    <td>
                        <span class="staff-cccd" th:text="${staff.idCitizenCard}"></span>
                    </td>
                    <td>
                        <span class="staff-role" th:text="${staff.roleName}"></span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a th:href="@{'/admin/staff-list/detail/' + ${staff.staffid}}" class="btn-icon" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </a>

                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>


    <!-- Pagination -->
    <div class="pagination">
        <div class="pagination">
            <a th:classappend="${currentPage == 1} ? ' disabled'"
               th:href="@{staff-list(page=1, size=${size})}">« Đầu</a>

            <a th:if="${currentPage > 1}"
               th:href="@{staff-list(page=${currentPage - 1}, size=${size})}">‹ Trước</a>
            <!-- Show up to 5 page numbers centered around currentPage -->
            <span th:each="p : ${#numbers.sequence(
                        currentPage > 3 ? currentPage - 2 : 1,
                        currentPage < totalPages - 2 ? currentPage + 2 : totalPages)}">
    <a th:if="${p != currentPage}" th:text="${p}"
       th:href="@{staff-list(page=${p}, size=${size})}"></a>
    <span th:if="${p == currentPage}" th:text="${p}" class="active"></span>
  </span>

            <a th:if="${currentPage < totalPages}"
               th:href="@{staff-list(page=${currentPage + 1}, size=${size})}">Sau ›</a>

            <a th:classappend="${currentPage == totalPages} ? ' disabled'"
               th:href="@{staff-list(page=${totalPages}, size=${size})}">Cuối »</a>
    </div>
    </div>
    </div>
</main>
<script>
    (function initStaffSorting(){
        const table = document.getElementById('staffTable');
        if (!table) return;

        const tbody = table.querySelector('tbody');
        const sortAscBtn   = document.getElementById('sortAscBtn');
        const sortDescBtn  = document.getElementById('sortDescBtn');
        const sortResetBtn = document.getElementById('sortResetBtn');

        // Mark original order so we can reset later
        Array.from(tbody.querySelectorAll('tr')).forEach((row, i) => {
            row.dataset.origIndex = String(i);
        });

        function setActive(btn){
            [sortAscBtn, sortDescBtn, sortResetBtn].forEach(b => b && b.classList.remove('active'));
            btn && btn.classList.add('active');
        }

        function sortRows(order) {
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                if (order === 'none') {
                    return Number(a.dataset.origIndex) - Number(b.dataset.origIndex);
                }
                const aName = (a.querySelector('.staff-name')?.textContent || '').trim().toLowerCase();
                const bName = (b.querySelector('.staff-name')?.textContent || '').trim().toLowerCase();

                const cmp = aName.localeCompare(bName, 'vi', { sensitivity: 'base' });
                return order === 'asc' ? cmp : -cmp; // 'desc'
            });

            // Re-append in new order (keeps any row.style.display set by your search)
            rows.forEach(r => tbody.appendChild(r));
        }

        // Hook buttons
        sortAscBtn  && sortAscBtn.addEventListener('click',  () => { sortRows('asc');  setActive(sortAscBtn);  });
        sortDescBtn && sortDescBtn.addEventListener('click', () => { sortRows('desc'); setActive(sortDescBtn); });
        sortResetBtn&& sortResetBtn.addEventListener('click', () => { sortRows('none'); setActive(sortResetBtn); });
    })();
    // Live search on current page (filters rows by multiple fields)
    function attachStaffSearch() {
        const input = document.getElementById('searchInput');
        const table = document.getElementById('staffTable');
        if (!input || !table) return;

        const rows = Array.from(table.querySelectorAll('tbody tr'));

        input.addEventListener('input', function (e) {
            const q = e.target.value.trim().toLowerCase();

            rows.forEach(row => {
                const name = row.querySelector('.staff-name')?.textContent.toLowerCase() || '';
                const email = row.querySelector('.staff-email')?.textContent.toLowerCase() || '';
                const phone = row.querySelector('.staff-phone')?.textContent.toLowerCase() || '';
                const cccd = row.querySelector('.staff-cccd')?.textContent.toLowerCase() || '';
                const role = row.querySelector('.staff-role')?.textContent.toLowerCase() || '';

                const match = !q || name.includes(q) || email.includes(q) || phone.includes(q) || cccd.includes(q) || role.includes(q);
                row.style.display = match ? '' : 'none';
            });
        });
    }

    // Export to Excel (only visible rows)
    function exportStaffExcel() {
        const table = document.querySelector('.data-table');
        const visibleRows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');

        const data = [];
        data.push(['Tên nhân viên', 'Email', 'SĐT', 'CCCD', 'Role']);

        visibleRows.forEach(row => {
            const rowData = [
                row.querySelector('.staff-name')?.textContent.trim() || '',
                row.querySelector('.staff-email')?.textContent.trim() || '',
                row.querySelector('.staff-phone')?.textContent.trim() || '',
                row.querySelector('.staff-cccd')?.textContent.trim() || '',
                row.querySelector('.staff-role')?.textContent.trim() || ''
            ];
            data.push(rowData);
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Nhân viên');

        const fileName = 'danh_sach_nhan_vien_' + new Date().toISOString().slice(0, 10) + '.xlsx';
        XLSX.writeFile(wb, fileName);
    }

    // Expose export function to the global scope (called by onclick in HTML)
    window.exportStaffExcel = exportStaffExcel;

    // Init
    window.addEventListener('DOMContentLoaded', attachStaffSearch);

</script>

</body>
</html>