<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách nhân viên</title>
    <link rel="stylesheet" th:href="@{/css/staff-list.css}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body>
<div th:replace="taskbar/manager-taskbar :: managerTaskbar"></div>
<!-- Main Content -->
<main class="main-content">

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <h1>Quản lý nhân viên</h1>
        </div>

        <div class="header-right">

        </div>
    </header>
    <!-- Page Content -->
    <div class="page-content">
        <!-- Page Header -->
        <div class="page-header">
            <h2 class="page-title">Danh sách nhân viên</h2>
            <div class="page-actions">
                <a th:href="@{'/admin/manager-dashboard'}" class="btn-secondary btn-back">
                    <i class="fas fa-arrow-left"></i> Back to Home </a>
            </div>
        </div>
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-group">
                <label for="searchInput">Tìm theo tên / email / SĐT/ CCCD/ role:</label>
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Nhập từ khóa..." class="filter-select">
                    <button type="button" id="searchBtn" class="btn-search">
                        <i class="fas fa-search"></i> Tìm kiếm
                    </button>
                    <button type="button" id="clearBtn" class="btn-clear">
                        <i class="fas fa-times"></i> Xóa
                    </button>
                </div>
            </div>
            <div class="filter-group">
                <label>Sắp xếp theo tên:</label>
                <div class="sort-container">
                    <button type="button" id="sortAscBtn" class="btn-sort">
                        <i class="fas fa-sort-alpha-down"></i> A-Z
                    </button>
                    <button type="button" id="sortDescBtn" class="btn-sort">
                        <i class="fas fa-sort-alpha-up"></i> Z-A
                    </button>
                    <button type="button" id="sortResetBtn" class="btn-sort active">
                        <i class="fas fa-sort"></i> Mặc định
                    </button>
                </div>
            </div>
        </div>

        <!-- Staff Table -->
    <div class="card">
        <div class="card-header">
            <div class="staff-count">
                Số nhân viên (<span th:text="${totalStaff}"></span>)
            </div>
            <div class="card-actions">
                <button onclick="exportStaffExcel()" class="export-excel-btn">
                    <i class="fas fa-download"></i> Xuất Excel
                </button>
            </div>
        </div>

        <div class="table-container">
            <table class="data-table" id="staffTable">
                <thead>
                <tr>
                    <th>Tên nhân viên</th>
                    <th>Email</th>
                    <th>SĐT</th>
                    <th>CCCD</th>
                    <th>Role</th>
                    <th>Hành động</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="staff : ${staffs}">
                    <td><span class="staff-name"  th:text="${staff.fullname}"></span></td>
                    <td><span class="staff-email" th:text="${staff.email}"></span></td>
                    <td><span class="staff-phone" th:text="${staff.phone}"></span></td>
                    <td><span class="staff-cccd"  th:text="${staff.idCitizenCard}"></span></td>
                    <td>
                    <td>
  <span class="status-badge staff-role"
        th:classappend="${#strings.toUpperCase(staff.roleName)} == 'BLOCKED' ? ' blocked' : ''"
        th:text="${staff.roleName}">STAFF</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <!-- View -->
                            <a th:href="@{'/admin/staff-list/detail/' + ${staff.staffid}}" class="btn-icon" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </a>

                            <!-- Toggle Block -->
                            <form th:action="@{'/admin/staffs/' + ${staff.staffid} + '/toggle-block'}" method="post"
                                  th:onsubmit="return confirm('Bạn có chắc chắn muốn ' + ( (${#strings.toUpperCase(staff.roleName)} == 'BLOCKED') ? 'mở khóa' : 'khóa') + ' nhân viên này?')"
                                  style="display:inline;">
                                <button type="submit" class="btn-icon"
                                        th:title="${#strings.toUpperCase(staff.roleName)} == 'BLOCKED' ? 'Mở khóa' : 'Khóa'">
                                    <i class="fas"
                                       th:classappend="${#strings.toUpperCase(staff.roleName)} == 'BLOCKED' ? ' fa-lock-open' : ' fa-lock'"></i>
                                </button>
                            </form>


                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>


        <div id="serverPager" class="pagination pagination-arrows">
            <a class="pager-btn"
               th:classappend="${currentPage == 1} ? ' disabled'"
               th:href="@{/admin/staff-list(page=${currentPage - 1}, size=${size})}">
                <i class="fas fa-chevron-left"></i>
            </a>

            <span class="pager-indicator" th:text="${currentPage} + ' / ' + ${totalPages}"></span>

            <a class="pager-btn"
               th:classappend="${currentPage == totalPages} ? ' disabled'"
               th:href="@{/admin/staff-list(page=${currentPage + 1}, size=${size})}">
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>

        <!-- shows only while searching -->
        <div id="searchPagerNote" style="display:none; text-align:center; margin-top:10px; color:#6c757d;">
            Đang lọc kết quả trên trang hiện tại. Điều hướng phân trang đã được tắt.
        </div>

    </div>
    </div>
</main>
<script th:inline="none">
    (function initStaffSorting(){
        const table = document.getElementById('staffTable');
        if (!table) return;

        const tbody = table.querySelector('tbody');
        const sortAscBtn   = document.getElementById('sortAscBtn');
        const sortDescBtn  = document.getElementById('sortDescBtn');
        const sortResetBtn = document.getElementById('sortResetBtn');

        // mark original order
        Array.from(tbody.querySelectorAll('tr')).forEach((row, i) => {
            row.dataset.origIndex = String(i);
        });

        function setActive(btn){
            [sortAscBtn, sortDescBtn, sortResetBtn].forEach(b => b && b.classList.remove('active'));
            if (btn) btn.classList.add('active');
        }

        function sortRows(order) {
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort((a, b) => {
                if (order === 'none') {
                    return Number(a.dataset.origIndex) - Number(b.dataset.origIndex);
                }
                const aName = ((a.querySelector('.staff-name') || {}).textContent || '').trim().toLowerCase();
                const bName = ((b.querySelector('.staff-name') || {}).textContent || '').trim().toLowerCase();
                const cmp = aName.localeCompare(bName, 'vi', { sensitivity: 'base' });
                return order === 'asc' ? cmp : -cmp;
            });
            rows.forEach(r => tbody.appendChild(r));
        }

        // expose so clear can reset sort
        window._staffSort = { sortRows, setActive, sortResetBtn };

        if (sortAscBtn)   sortAscBtn.addEventListener('click',  () => { sortRows('asc');  setActive(sortAscBtn);  });
        if (sortDescBtn)  sortDescBtn.addEventListener('click', () => { sortRows('desc'); setActive(sortDescBtn); });
        if (sortResetBtn) sortResetBtn.addEventListener('click', () => { sortRows('none'); setActive(sortResetBtn); });
    })();

    // helpers
    function textLower(el){ return (el && el.textContent ? el.textContent : '').trim().toLowerCase(); }

    function updatePagerVisibility() {
        const searching = (document.getElementById('searchInput')?.value || '').trim().length > 0;
        const serverPager = document.getElementById('serverPager');
        const note = document.getElementById('searchPagerNote');

        if (serverPager) serverPager.style.display = searching ? 'none' : '';
        if (note) note.style.display = searching ? '' : 'none';
    }

    // call this whenever search text changes or you clear it
    function performStaffSearch() {
        const q = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
        const rows = Array.from(document.querySelectorAll('#staffTable tbody tr'));
        rows.forEach(row => {
            const name  = row.querySelector('.staff-name') ?.textContent.toLowerCase() || '';
            const email = row.querySelector('.staff-email')?.textContent.toLowerCase() || '';
            const phone = row.querySelector('.staff-phone')?.textContent.toLowerCase() || '';
            const cccd  = row.querySelector('.staff-cccd') ?.textContent.toLowerCase() || '';
            const role  = row.querySelector('.staff-role') ?.textContent.toLowerCase() || '';
            const match = !q || name.includes(q) || email.includes(q) || phone.includes(q) || cccd.includes(q) || role.includes(q);
            row.style.display = match ? '' : 'none';
        });
        updatePagerVisibility();
    }

    function clearStaffSearch() {
        const input = document.getElementById('searchInput');
        if (input) input.value = '';
        performStaffSearch();                      // shows all rows again
        if (window._staffSort) {                   // reset sorting UI + order if you exposed it earlier
            window._staffSort.sortRows('none');
            window._staffSort.setActive(window._staffSort.sortResetBtn);
        }
        input?.focus();
    }

    // Export to Excel (visible rows only)
    function cellText(row, sel){
        const el = row.querySelector(sel);
        return el ? el.textContent.trim() : '';
    }
    function exportStaffExcel() {
        const table = document.querySelector('.data-table');
        const visibleRows = Array.from(table.querySelectorAll('tbody tr')).filter(r => r.style.display !== 'none');
        const data = [['Tên nhân viên','Email','SĐT','CCCD','Role']];
        visibleRows.forEach(row => {
            data.push([
                cellText(row, '.staff-name'),
                cellText(row, '.staff-email'),
                cellText(row, '.staff-phone'),
                cellText(row, '.staff-cccd'),
                cellText(row, '.staff-role')
            ]);
        });
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Nhân viên');
        XLSX.writeFile(wb, 'danh_sach_nhan_vien_' + new Date().toISOString().slice(0,10) + '.xlsx');
    }
    window.exportStaffExcel = exportStaffExcel;

    // wire up
    window.addEventListener('DOMContentLoaded', () => {
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn  = document.getElementById('clearBtn');
        const input     = document.getElementById('searchInput');

        if (input) {
            input.addEventListener('input', performStaffSearch);
            input.addEventListener('keypress', e => { if (e.key === 'Enter') performStaffSearch(); });
        }
        if (searchBtn) searchBtn.addEventListener('click', performStaffSearch);
        if (clearBtn)  clearBtn.addEventListener('click', clearStaffSearch);
    });

</script>



</body>
</html>