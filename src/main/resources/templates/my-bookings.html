<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đơn hàng của tôi - QVL Storage</title>
    <link rel="stylesheet" th:href="@{/css/booking-detail.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .orders-container {
            max-width: 2500px;
            margin: 0 auto;
            padding: 20px;
        }

        .order-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.2s ease;
            max-width: 2500px;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .order-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-id {
            font-size: 18px;
            font-weight: bold;
        }

        .order-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-confirmed {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #fff3cd;
        }

        .status-cancelled {
            background: rgba(220, 53, 69, 0.2);
            color: #f8d7da;
        }

        .status-paid {
            background: rgba(40, 167, 69, 0.2);
            color: #d4edda;
        }

        .order-body {
            padding: 25px;
        }

        .order-info {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* Hiển thị 5 cột trên một hàng */
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .info-value {
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }

        .order-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-success:disabled {
            background: #6c757d;
            color: white;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .contract-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            text-transform: uppercase;
        }

        .contract-signed {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .contract-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .total-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .total-amount {
            font-size: 24px;
            font-weight: bold;
            margin-top: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #ddd;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .amount-highlight {
            color: #28a745;
            font-weight: bold;
        }
        .orders-container { max-width: 2500px; margin: 0 auto; padding: 20px; }
        .order-card { background:#fff; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,.1);
            margin-bottom:20px; overflow:hidden; transition:transform .2s ease; max-width:2500px; }
        .order-card:hover { transform:translateY(-2px); box-shadow:0 8px 15px rgba(0,0,0,.15); }
        .order-header { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:20px;
            display:flex; justify-content:space-between; align-items:center; }
        .order-id { font-size:18px; font-weight:700; }
        .order-status { padding:8px 16px; border-radius:20px; font-size:12px; font-weight:600; text-transform:uppercase; }
        .status-confirmed{ background:rgba(255,255,255,.2); color:#fff; }
        .status-pending{ background:rgba(255,193,7,.2); color:#fff3cd; }
        .status-cancelled{ background:rgba(220,53,69,.2); color:#f8d7da; }
        .status-approved{ background:rgba(23,162,184,.2); color:#d1ecf1; }
        .status-rejected{ background:rgba(220,53,69,.2);  color:#f8d7da; }
        .status-paid{ background:rgba(40,167,69,.2); color:#d4edda; }
        .order-body{ padding:25px; }
        .order-info{ display:grid; grid-template-columns:repeat(5,1fr); gap:20px; margin-bottom:20px; }
        .info-item{ display:flex; flex-direction:column; gap:5px; }
        .info-label{ font-size:14px; color:#666; font-weight:500; }
        .info-value{ font-size:16px; color:#333; font-weight:600; }
        .order-actions{ display:flex; gap:10px; justify-content:flex-end; padding-top:20px; border-top:1px solid #eee; }
        .btn{ padding:10px 20px; border:none; border-radius:6px; font-size:14px; font-weight:500; cursor:pointer;
            text-decoration:none; display:inline-flex; align-items:center; gap:8px; transition:all .2s ease; }
        .btn-primary{ background:#007bff; color:#fff; } .btn-primary:hover{ background:#0056b3; }
        .btn-secondary{ background:#6c757d; color:#fff; } .btn-secondary:hover{ background:#545b62; }
        .btn-danger{ background:#dc3545; color:#fff; } .btn-danger:hover{ background:#c82333; }
        .btn-success{ background:#28a745; color:#fff; } .btn-success:hover{ background:#218838; }
        .btn-success:disabled{ background:#6c757d; color:#fff; cursor:not-allowed; opacity:.6; }
        .contract-status{ display:inline-flex; align-items:center; gap:5px; font-size:12px; font-weight:600;
            padding:4px 8px; border-radius:12px; text-transform:uppercase; }
        .contract-signed{ background:rgba(40,167,69,.2); color:#28a745; }
        .contract-pending{ background:rgba(255,193,7,.2); color:#ffc107; }
        .empty-state{ text-align:center; padding:60px 20px; color:#666; }
        .empty-state i{ font-size:64px; margin-bottom:20px; color:#ddd; }
        .empty-state h3{ margin-bottom:10px; color:#333; }
        .amount-highlight{ color:#28a745; font-weight:700; }
    </style>
</head>
<body>
<div class="page-wrapper">
    <!-- Navigation -->
    <div th:replace="taskbar/customer-navbar :: customerNavbar"></div>

    <!-- Hero -->
    <div class="hero-section">
        <div class="hero-content">
            <h1>Đơn hàng của tôi</h1>
            <p>Quản lý và theo dõi tất cả đơn hàng thuê kho của bạn</p>
        </div>
    </div>

    <!-- Main -->
    <div class="container">
        <div class="content-section">
            <div class="section-header">
                <div class="header-info">
                    <h2><i class="fas fa-list-alt"></i> Danh sách đơn hàng</h2>
                    <p th:text="'Tổng cộng: ' + ${orders.size()} + ' đơn hàng'"></p>
                </div>
                <div class="header-actions">
                    <a href="/SWP/storages" class="btn btn-primary"><i class="fas fa-plus"></i> Đặt kho</a>

                    <!-- NEW: go to My Transactions -->
                    <a href="/SWP/customers/my-transactions" class="btn btn-secondary">
                        <i class="fas fa-receipt"></i> Lịch sử giao dịch
                    </a>
                    <a href="#" id="btn-expired-orders" class="btn btn-secondary"><i class="fas fa-hourglass-end"></i> Đơn hết hạn</a>
                </div>
            </div>

            <!-- Inline expired orders section -->
            <div id="expired-orders-wrap" style="display:none; margin: 10px 0 20px 0;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <h3 id="expired-title" style="margin:0; font-size:18px;"><i class="fas fa-hourglass-end"></i> Đơn đã hết hạn</h3>
                    <button id="btn-hide-expired" class="btn btn-secondary" type="button"><i class="fas fa-times"></i> Ẩn</button>
                </div>
                <div id="expired-loading" style="padding:12px; color:#666; display:none;"><i class="fas fa-spinner fa-spin"></i> Đang tải...</div>
                <div id="expired-empty" style="padding:16px; color:#666; display:none; text-align:center;">
                    <i class="fas fa-inbox" style="font-size:32px; color:#ddd;"></i>
                    <div>Không có đơn đã hết hạn.</div>
                </div>
                <div id="expired-error" style="padding:12px; color:#dc3545; display:none;"></div>
                <!-- Danh sách card giống my bookings -->
                <div id="expired-list" class="orders-container" style="padding:0; display:none;"></div>
            </div>

            <div id="active-orders" class="orders-container">
                <!-- Có đơn hàng -->
                <div th:if="${orders != null and !orders.empty}">
                    <div th:each="order : ${orders}" class="order-card">
                        <div class="order-header">
                            <div class="order-id"><span th:text="'Đơn hàng'"></span></div>
                            <div class="order-status" th:switch="${order.status}">
                                <span th:case="'PENDING'"   class="status-pending"   th:text="${order.status}">PENDING</span>
                                <span th:case="'APPROVED'"  class="status-approved"  th:text="${order.status}">APPROVED</span>
                                <span th:case="'CONFIRMED'" class="status-confirmed" th:text="${order.status}">CONFIRMED</span>
                                <span th:case="'PAID'"      class="status-paid"      th:text="${order.status}">PAID</span>
                                <span th:case="'REJECTED'"  class="status-rejected"  th:text="${order.status}">REJECTED</span>
                                <span th:case="'CANCELLED'" class="status-cancelled" th:text="${order.status}">CANCELLED</span>

                                <!-- fallback: if a new/unknown status appears -->
                                <span th:case="*" class="status-pending" th:text="${order.status}">UNKNOWN</span>
                            </div>
                        </div>

                        <div class="order-body">
                            <div class="order-info">
                                <div class="info-item">
                                    <div class="info-label"><i class="fas fa-warehouse"></i> Tên kho</div>
                                    <div class="info-value" th:text="${order.storage.storagename}"></div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label"><i class="fas fa-calendar-alt"></i> Thời gian thuê</div>
                                    <div class="info-value"
                                         th:text="${#temporals.format(order.startDate, 'dd/MM/yyyy')} + ' - ' + ${#temporals.format(order.endDate, 'dd/MM/yyyy')}"></div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label"><i class="fas fa-expand-arrows-alt"></i> Diện tích</div>
                                    <div class="info-value" th:text="${order.rentalArea} + ' m²'"></div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label"><i class="fas fa-money-bill-wave"></i> Tổng tiền</div>
                                    <div class="info-value amount-highlight"
                                         th:text="${#numbers.formatDecimal(order.totalAmount, 1, 'POINT', 2, 'COMMA')} + ' VNĐ'"></div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label"><i class="fas fa-calendar-plus"></i> Ngày đặt</div>
                                    <div class="info-value" th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy')}"></div>
                                </div>
                            </div>

                            <div class="order-actions">
                                <a th:href="@{'/SWP/booking/detail?orderId=' + ${order.id}}" class="btn btn-primary">
                                    <i class="fas fa-eye"></i> Xem chi tiết
                                </a>

                                <a th:href="@{'/SWP/booking/contract?orderId=' + ${order.id}}" class="btn btn-secondary">
                                    <i class="fas fa-file-contract"></i> Hợp đồng
                                    <span th:if="${order.eContract != null and order.eContract.status.name() == 'SIGNED'}"
                                          class="contract-status contract-signed">
                    <i class="fas fa-check-circle"></i> Đã ký
                  </span>
                                    <span th:if="${order.eContract == null or order.eContract.status.name() != 'SIGNED'}"
                                          class="contract-status contract-pending">
                    <i class="fas fa-clock"></i> Chờ ký
                  </span>
                                </a>

                                <!-- Pay ONE order (only when eligible) -->

                                <a th:if="${order.status == 'APPROVED'
        and order.eContract != null
        and order.eContract.status.name() == 'SIGNED'}"
                                   th:href="@{/SWP/orders/{id}/pay(id=${order.id})}"
                                   class="btn btn-success">
                                    <i class="fas fa-credit-card"></i> Thanh toán
                                </a>


                                <!-- Hủy (chỉ PENDING) -->
                                <form th:if="${order.status == 'PENDING'}"
                                      th:action="@{'/SWP/customers/cancel-order/' + ${order.id}}"
                                      method="post" style="display:inline;"
                                      onsubmit="return confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')">
                                    <button type="submit" class="btn btn-danger">
                                        <i class="fas fa-times"></i> Hủy đơn
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>




                <!-- Không có đơn hàng -->
                <div th:if="${orders == null or orders.empty}" class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>Chưa có đơn hàng nào</h3>
                    <p>Bạn chưa có đơn hàng thuê kho nào. Hãy bắt đầu đặt kho ngay!</p>
                    <a href="/SWP/storages" class="btn btn-primary" style="margin-top:20px;">
                        <i class="fas fa-warehouse"></i> Khám phá kho
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div th:replace="taskbar/customer-footer :: customerFooter"></div>
</div>
<script>
  (function(){
    const btn = document.getElementById('btn-expired-orders');
    const wrap = document.getElementById('expired-orders-wrap');
    const btnHide = document.getElementById('btn-hide-expired');
    const loading = document.getElementById('expired-loading');
    const empty = document.getElementById('expired-empty');
    const errorBox = document.getElementById('expired-error');
    const expiredList = document.getElementById('expired-list');
    const activeOrders = document.getElementById('active-orders');

    function fmtMoney(n){
      try { return new Intl.NumberFormat('vi-VN').format(n) + ' VNĐ'; } catch(e){ return n + ' VNĐ'; }
    }
    function escapeHtml(s){
      return (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
    function fmtDate(iso){
      if(!iso) return '';
      // Expect YYYY-MM-DD
      const p = iso.split('-');
      if(p.length===3) return `${p[2]}/${p[1]}/${p[0]}`;
      // Fallback
      try{ return new Date(iso).toLocaleDateString('vi-VN'); }catch(e){ return iso; }
    }
    // Chuẩn hóa về ngày cuối tháng theo kiểu YYYY-MM-DD
    function endOfMonthIso(iso){
      if(!iso) return '';
      const parts = iso.split('T')[0].split('-');
      if(parts.length < 2) return iso;
      const y = Number(parts[0]);
      const m = Number(parts[1]);
      if(!y || !m) return iso;
      const lastDay = new Date(y, m, 0).getDate();
      const mm = String(m).padStart(2,'0');
      const dd = String(lastDay).padStart(2,'0');
      return `${parts[0]}-${mm}-${dd}`;
    }
    function fmtEndOfMonth(iso){
      const eom = endOfMonthIso(iso);
      return fmtDate(eom || iso);
    }
    function statusClass(st){
      const m = {
        'PENDING':'status-pending',
        'APPROVED':'status-approved',
        'CONFIRMED':'status-confirmed',
        'PAID':'status-paid',
        'REJECTED':'status-rejected',
        'CANCELLED':'status-cancelled'
      };
      return m[st] || 'status-pending';
    }
    function buildCard(o){
      const storName = o.storage && o.storage.storagename ? o.storage.storagename : 'N/A';
      const card = document.createElement('div');
      card.className = 'order-card';
      const storageId = o.storage && (o.storage.storageid || o.storage.id);
      const rebookHref = storageId ? `/SWP/storages/${storageId}` : '/SWP/storages';
      card.innerHTML = `
        <div class="order-header">
          <div class="order-id"><span>Đơn hàng</span></div>
          <div class="order-status ${statusClass(o.status)}">${escapeHtml(o.status||'')}</div>
        </div>
        <div class="order-body">
          <div class="order-info">
            <div class="info-item">
              <div class="info-label"><i class="fas fa-warehouse"></i> Tên kho</div>
              <div class="info-value">${escapeHtml(storName)}</div>
            </div>
            <div class="info-item">
              <div class="info-label"><i class="fas fa-calendar-alt"></i> Thời gian thuê</div>
              <div class="info-value">${fmtDate(o.startDate)} - ${fmtEndOfMonth(o.endDate)}</div>
            </div>
            <div class="info-item">
              <div class="info-label"><i class="fas fa-expand-arrows-alt"></i> Diện tích</div>
              <div class="info-value">${escapeHtml(o.rentalArea)} m²</div>
            </div>
            <div class="info-item">
              <div class="info-label"><i class="fas fa-money-bill-wave"></i> Tổng tiền</div>
              <div class="info-value amount-highlight">${fmtMoney(o.totalAmount)}</div>
            </div>
            <div class="info-item">
              <div class="info-label"><i class="fas fa-calendar-check"></i> Ngày kết thúc</div>
              <div class="info-value">${fmtEndOfMonth(o.endDate)}</div>
            </div>
          </div>
          <div class="order-actions" style="display:flex; gap:8px; flex-wrap:wrap;">
            <a href="${rebookHref}" class="btn btn-success">
              <i class="fas fa-rotate-right"></i> Đặt lại
            </a>
            <a href="/SWP/booking/detail?orderId=${o.id}" class="btn btn-secondary">
              <i class="fas fa-eye"></i> Xem chi tiết
            </a>
          </div>
        </div>`;
      return card;
    }
    function renderCards(items){
      expiredList.innerHTML = '';
      items.forEach(o => expiredList.appendChild(buildCard(o)));
    }

    async function loadExpired(){
      errorBox.style.display = 'none';
      empty.style.display = 'none';
      expiredList.style.display = 'none';
      loading.style.display = 'block';
      try{
        const res = await fetch('/SWP/customers/expired-orders/data', { headers: { 'Accept': 'application/json' }});
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        console.log('expired-orders/data response:', data);
        const items = Array.isArray(data) ? data : (Array.isArray(data.data) ? data.data : []);
        const title = document.getElementById('expired-title');
        if(title){
          title.innerHTML = `<i class="fas fa-hourglass-end"></i> Đơn đã hết hạn` + (items.length? ` (<strong>${items.length}</strong>)` : '');
        }
        if(items.length === 0){
          empty.style.display = 'block';
        } else {
          renderCards(items);
          expiredList.style.display = 'block';
        }
      } catch(e){
        errorBox.textContent = 'Không thể tải đơn hết hạn: ' + e.message;
        errorBox.style.display = 'block';
      } finally {
        loading.style.display = 'none';
      }
    }

    if(btn){
      btn.addEventListener('click', function(ev){
        ev.preventDefault();
        wrap.style.display = 'block';
        if(activeOrders) activeOrders.style.display = 'none';
        loadExpired();
      });
    }
    if(btnHide){
      btnHide.addEventListener('click', function(){
        wrap.style.display = 'none';
        if(activeOrders) activeOrders.style.display = '';
      });
    }
  })();
</script>
</body>
</html>
