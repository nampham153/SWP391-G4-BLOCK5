<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage List - Staff Manager</title>
    <link rel="stylesheet" th:href="@{/css/staff-dashboard.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<!-- Sidebar -->
<div th:replace="taskbar/staff-taskbar :: staffTaskbar"></div>
<main class="main-content">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
            <h1>Kho của tôi</h1>
        </div>
    </header>
    <!-- Page Content -->
    <div class="page-content">
        <!-- Page Header -->
        <div class="page-header">
            <h2 class="page-title">Thông tin kho được giao</h2>
            <div class="page-actions">
                <button class="btn-secondary btn-back">
                    <a href="/SWP/staff/staff-dashboard" style="color: inherit; text-decoration: none;">
                        <i class="fas fa-arrow-left"></i>
                        Quay Lại Dashboard
                    </a>
                </button>
            </div>
        </div>
        
        <!-- Storage Detail Cards -->
        <div class="card" th:if="${#lists.isEmpty(storages)}">
            <div class="card-header"><h3>Kho của bạn</h3></div>
            <div style="padding:20px; color:#64748b;">Hiện chưa có kho nào được gán cho bạn.</div>
        </div>

        <div th:each="storage : ${storages}" class="card">
            <div class="card-header">
                <h3 th:text="'Kho #' + ${storage.storageid} + ' - ' + ${storage.storagename}">Kho</h3>
            </div>
            <div style="display:grid; grid-template-columns: 320px 1fr; gap:20px; padding: 20px; align-items:start;">
                <div>
                    <img th:src="${storage.imUrl} ?: '/images/default-storage.jpg'" alt="Storage image"
                         style="width:100%; height:220px; object-fit:cover; border-radius:12px;"/>
                </div>
                <div class="detail-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
                    <div class="detail-row"><span class="detail-label">Trạng thái</span>
                        <span class="detail-value">
                            <span th:class="${storage.status} ? 'status-badge active' : 'status-badge warning'"
                                  th:text="${storage.status} ? 'Còn trống' : 'Đã thuê'"></span>
                        </span>
                    </div>
                    <div class="detail-row"><span class="detail-label">Giá/ngày</span>
                        <span class="detail-value" th:text="${#numbers.formatDecimal(storage.pricePerDay, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span>
                    </div>
                    <div class="detail-row"><span class="detail-label">Diện tích</span>
                        <span class="detail-value" th:text="${storage.area} + ' m²'"></span>
                    </div>
                    <div class="detail-row"><span class="detail-label">Tọa độ</span>
                        <span class="detail-value" th:text="(${storage.latitude} != null ? ${storage.latitude} : 'N/A') + ', ' + (${storage.longitude} != null ? ${storage.longitude} : 'N/A')"></span>
                    </div>
                    <div class="detail-row" style="grid-column:1 / -1;"><span class="detail-label">Địa chỉ</span>
                        <span class="detail-value" th:text="${storage.address} + ', ' + ${storage.state} + ', ' + ${storage.city}"></span>
                    </div>
                    <div class="detail-row" style="grid-column:1 / -1;"><span class="detail-label">Mô tả</span>
                        <span class="detail-value" th:text="${storage.description}"></span>
                    </div>
                    <div class="detail-row" style="grid-column:1 / -1; display:flex; gap:8px;">
                        <a th:href="@{'/SWP/staff/storages/' + ${storage.getStorageid()} + '/detail'}" class="btn-primary" style="text-decoration:none; padding:10px 14px; border-radius:8px; color:#fff; display:inline-flex; align-items:center; gap:8px;">
                            <i class="fas fa-eye"></i> Xem chi tiết
                        </a>
                        <form th:action="@{'/SWP/staff/storages/' + ${storage.getStorageid()} + '/toggle-status'}" method="post" style="display:inline;">
                            <input type="hidden" name="returnUrl" value="/SWP/staff/staff-all-storage"/>
                            <button type="submit" class="btn-secondary" style="padding:10px 14px; border-radius:8px; display:inline-flex; align-items:center; gap:8px;">
                                <i class="fas fa-exchange-alt"></i> Chuyển trạng thái
                            </button>
                        </form>
                        <form th:if="${storage.status}" th:action="@{'/SWP/staff/storages/' + ${storage.getStorageid()} + '/delete'}" method="post" style="display:inline;" onsubmit="return confirm('Bạn có chắc là xóa kho này không?');">
                            <input type="hidden" name="returnUrl" value="/SWP/staff/staff-all-storage"/>
                            <button type="submit" class="btn-danger" style="padding:10px 14px; border-radius:8px; color:#fff; background:#ef4444; display:inline-flex; align-items:center; gap:8px;">
                                <i class="fas fa-trash"></i> Xóa kho
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    const COLUMN_COUNT = 7;
    const rowsPerPage = 10;
    let currentPage = 1;

    document.addEventListener('DOMContentLoaded', function () {
        // Gán sự kiện lọc, sắp xếp
        document.getElementById('statusFilter').addEventListener('change', applyFiltersAndPaginate);
        document.getElementById('areaFilter').addEventListener('change', applyFiltersAndPaginate);
        document.getElementById('priceFilter').addEventListener('change', applyFiltersAndPaginate);
        document.getElementById('sortSelect').addEventListener('change', applyFiltersAndPaginate);

        // Gọi lần đầu
        applyFiltersAndPaginate();
    });

    function applyFiltersAndPaginate() {
        const status = document.getElementById('statusFilter').value;
        const area = document.getElementById('areaFilter').value;
        const price = document.getElementById('priceFilter').value;
        const sort = document.getElementById('sortSelect').value;

        const rows = Array.from(document.querySelectorAll('.data-table tbody tr'));
        let visibleRows = [];

        rows.forEach(row => {
            const statusText = row.querySelector('.status-badge')?.textContent.trim().toLowerCase() || '';
            const areaValue = parseFloat(row.children[3].textContent.replace(/[^\d.]/g, '')) || 0;
            const priceValue = parseFloat(row.children[4].textContent.replace(/[^\d.]/g, '')) || 0;

            let show = true;

            if (status === 'available' && !statusText.includes('còn trống')) show = false;
            if (status === 'occupied' && !statusText.includes('đã thuê')) show = false;

            if (area === 'small' && !(areaValue < 200)) show = false;
            if (area === 'medium' && !(areaValue >= 200 && areaValue <= 800)) show = false;
            if (area === 'large' && !(areaValue > 800)) show = false;

            if (price === 'low' && !(priceValue < 150000)) show = false;
            if (price === 'medium' && !(priceValue >= 150000 && priceValue <= 300000)) show = false;
            if (price === 'high' && !(priceValue > 300000)) show = false;

            row.style.display = show ? '' : 'none';
            row.dataset.filtered = show ? 'true' : 'false';

            if (show) visibleRows.push(row);
        });

        // Sắp xếp
        if (sort) {
            visibleRows.sort((a, b) => {
                const areaA = parseFloat(a.children[3].textContent.replace(/[^\d.]/g, '')) || 0;
                const areaB = parseFloat(b.children[3].textContent.replace(/[^\d.]/g, '')) || 0;
                const priceA = parseFloat(a.children[4].textContent.replace(/[^\d.]/g, '')) || 0;
                const priceB = parseFloat(b.children[4].textContent.replace(/[^\d.]/g, '')) || 0;

                switch (sort) {
                    case 'priceAsc': return priceA - priceB;
                    case 'priceDesc': return priceB - priceA;
                    case 'areaAsc': return areaA - areaB;
                    case 'areaDesc': return areaB - areaA;
                    default: return 0;
                }
            });

            // Re-append to tbody
            const tbody = document.querySelector('.data-table tbody');
            visibleRows.forEach(row => tbody.appendChild(row));
        }

        currentPage = 1;
        const totalPages = Math.max(1, Math.ceil(visibleRows.length / rowsPerPage));
        renderPagination(totalPages);
        showPage(currentPage);
        document.getElementById('totalCount').textContent = visibleRows.length;
    }

    function showPage(page) {
        const rows = Array.from(document.querySelectorAll('.data-table tbody tr'))
            .filter(row => row.dataset.filtered === 'true');

        const totalPages = Math.max(1, Math.ceil(rows.length / rowsPerPage));
        currentPage = Math.min(Math.max(1, page), totalPages);

        rows.forEach((row, index) => {
            row.style.display = (index >= (currentPage - 1) * rowsPerPage && index < currentPage * rowsPerPage)
                ? '' : 'none';
        });

        highlightCurrentPage();
    }

    function renderPagination(totalPages) {
        const pagination = document.querySelector('.pagination');
        pagination.innerHTML = '';

        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
            }
        });
        pagination.appendChild(prevBtn);

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            if (i === currentPage) btn.classList.add('active');
            btn.addEventListener('click', () => {
                currentPage = i;
                showPage(currentPage);
            });
            pagination.appendChild(btn);
        }

        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                showPage(currentPage);
            }
        });
        pagination.appendChild(nextBtn);
    }

    function highlightCurrentPage() {
        const buttons = document.querySelectorAll('.pagination button');
        buttons.forEach(btn => {
            if (btn.textContent === String(currentPage)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    function clearFilters() {
        document.getElementById('statusFilter').value = '';
        document.getElementById('areaFilter').value = '';
        document.getElementById('priceFilter').value = '';
        document.getElementById('sortSelect').value = '';
        applyFiltersAndPaginate();
    }
</script>
</body>
</html>